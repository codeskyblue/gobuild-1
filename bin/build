#!/bin/bash

# fail fast
set -o errexit
set -o pipefail

# args
PROJECT="$1"

# determine root
root=$(cd $(dirname $0)/..; pwd)

# if there's no vendored go, download an appropriate one
if [[ ! -d $root/vendor/go ]]; then
  echo "Downloading go for $GOOS/$GOARCH"
  goroot=$(mktemp -t goroot_XXXXX)
  rm -rf $goroot
  mkdir -p $goroot
  cd $goroot
  curl -s http://${COMPILER_BUCKET}.s3.amazonaws.com/go-${GOVERSION}-${GOOS}-${GOARCH}.tgz | tar -xzf -
  export GOROOT="$goroot/go"
else
  echo "Using vendored go"
  export GOROOT="$root/vendor/go"
fi

# make a tempdir to build in
echo "Creating GOPATH"
gopath=$(mktemp -t gopath_XXXXX)
rm -rf $gopath
mkdir -p $gopath

# some vars for go
export PATH="$GOROOT/bin:/app/vendor/bin:$PATH"
export GOPATH="$gopath"

# set up godeps
if [ -f Godeps ]; then
  go get github.com/kr/godep
  alias go="$GOPATH/bin/godep go"
fi

if [[  "$KEY" != "" ]] && [[ "$SPAWN_ENV" != "local" ]]; then
  echo "Downloading key"
  mkdir ~/.ssh
  curl -s $KEY -o ~/.ssh/id_rsa
fi

# download project
echo "Downloading $PROJECT"
go get -d $PROJECT >/tmp/build.log

# clone the specified ref
cd $GOPATH/src/$PROJECT
if [[ ! -z $REF ]]; then
  git fetch origin
  git checkout $REF
fi

# set up version
echo "Setting version to $VERSION"
if [ -f version.go ]; then
  sed -e "s/Version = \"dev\"/Version = \"${VERSION}\"/" version.go > /tmp/version.go
  cp /tmp/version.go version.go
fi

echo "Compiling"
go get .

if [ -d $GOPATH/bin/${GOOS}_${GOARCH} ]; then
  BINARY="$(ls -1 $GOPATH/bin/${GOOS}_${GOARCH}/$(echo $PROJECT | cut -d/ -f3)*)"
else
  BINARY="$GOPATH/bin/$(echo $PROJECT | cut -d/ -f3)"
fi

echo "Uploading binary"
curl -X POST $BUILD_HOST/build/$BUILD_ID/binary -T $BINARY
